<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>J & M 시너스트리 + 트랜싯 (실제 천문)</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; text-align:center; }
    canvas { background:#fff; margin:20px auto; display:block; }
    #aspects { margin-top:20px; white-space:pre-line; font-family:monospace; }
  </style>
</head>
<body>
  <h1>J & M 시너스트리 + 트랜싯 (실제 천문)</h1>
  <p>날짜 선택: <input type="date" id="dateInput" value="2025-09-03"></p>
  <canvas id="chart" width="600" height="600"></canvas>
  <div id="aspects"></div>

<script>
// ===== 행성 이름 변환 =====
const planetNames = {
  Sun: "태양",
  Moon: "달",
  Mercury: "수성",
  Venus: "금성",
  Mars: "화성",
  Jupiter: "목성",
  Saturn: "토성",
  Uranus: "천왕성",
  Neptune: "해왕성",
  Pluto: "명왕성",
  Fortune: "포춘",
  Lilith: "릴리스",
  Node: "노드",
  Vertex: "버텍스"
};

// ===== 네이탈 좌표 (각도값만, 한국어 변환) =====
const natalJ = {
  name: "J",
  planets: {
    "태양": 280, "달": 203, "수성": 297, "금성": 258, "화성": 20,
    "목성": 56, "토성": 275, "천왕성": 271, "해왕성": 279, "명왕성": 224,
    "포춘": 193, "릴리스": 175, "노드": 337, "버텍스": 113
  }
};
const natalM = {
  name: "M",
  planets: {
    "태양": 6, "달": 132, "수성": 339, "금성": 51, "화성": 146,
    "목성": 181, "토성": 172, "천왕성": 235, "해왕성": 262, "명왕성": 200,
    "포춘": 233, "릴리스": 178, "노드": 147, "버텍스": 117
  }
};

// ===== 실제 천문 데이터 가져오기 =====
async function getTransit(date){
  const appId = "0ace3ece-819d-427b-b7a2-5e8b9461eb8b";        //
  const appSecret = "f4fbdab592c38875ad0b31163d5f71bc97a04ebf3088f024e5cdf935a2cb9fc3752cd8ab71c7a65bf4cc06752773464de708a7eceda622b52f8eb114d4de39a0be6ed7025293ce268e8a11738bc8c763dfe2a573d12954c057b6c167c0063816bc9d7edc03a78639e81c710cb253d16d"; // 
  const url = `https://api.astronomyapi.com/api/v2/studio/planet-position?date=${date}&latitude=35.1&longitude=129.0&elevation=0`;

  const headers = {
    "Authorization": "Basic " + btoa(`${appId}:${appSecret}`)
  };

  const res = await fetch(url,{headers});
  const data = await res.json();

  const trans = {};
  for(const body of data.data.table.rows){
    const eng = body.cells[0].id; // "sun","moon" 등
    const lon = body.cells[0].position.ecliptic.longitude; // 황도 경도 (더 정확)
    const kor = planetNames[eng.charAt(0).toUpperCase()+eng.slice(1)];
    if(kor) trans[kor] = lon;
  }
  return trans;
}

// ===== 차트 그리기 =====
function drawChart(ctx, dataJ, dataM, trans){
  ctx.clearRect(0,0,600,600);
  ctx.translate(300,300);
  ctx.beginPath();
  ctx.arc(0,0,280,0,2*Math.PI);
  ctx.stroke();
  
  function drawPlanets(planets,color){
    ctx.fillStyle=color;
    ctx.font="10px Arial";
    for(let p in planets){
      const angle = (planets[p]-90) * Math.PI/180;
      const x = 250 * Math.cos(angle);
      const y = 250 * Math.sin(angle);
      ctx.beginPath();
      ctx.arc(x,y,5,0,2*Math.PI);
      ctx.fill();
      ctx.fillText(p,x+8,y+4);
    }
  }
  drawPlanets(dataJ.planets,"blue");
  drawPlanets(dataM.planets,"green");
  drawPlanets(trans,"red");
  ctx.resetTransform();
}

// ===== 각도 계산 =====
function calcAspects(planetsA, planetsB){
  const aspects = [];
  const aspAngles = {0:"☌",60:"✶",90:"□",120:"△",180:"☍"};
  const orb = 3;
  for(let pA in planetsA){
    for(let pB in planetsB){
      const diff = Math.abs(planetsA[pA]-planetsB[pB])%360;
      const d = diff>180 ? 360-diff: diff;
      for(let a in aspAngles){
        if(Math.abs(d-Number(a))<=orb){
          aspects.push(`${pA} - ${pB}: ${aspAngles[a]} (±${(d-Number(a)).toFixed(1)}°)`);
        }
      }
    }
  }
  return aspects.join("\n");
}

// ===== 실행 =====
async function update(){
  const date = document.getElementById("dateInput").value;
  const trans = await getTransit(date);
  const ctx = document.getElementById("chart").getContext("2d");
  drawChart(ctx, natalJ, natalM, trans);

  const aspectsJM = calcAspects(natalJ.planets,natalM.planets);
  const aspectsJT = calcAspects(natalJ.planets,trans);
  const aspectsMT = calcAspects(natalM.planets,trans);

  document.getElementById("aspects").textContent =
    "[J vs M]\n"+aspectsJM+"\n\n[J vs Transit]\n"+aspectsJT+"\n\n[M vs Transit]\n"+aspectsMT;
}

document.getElementById("dateInput").addEventListener("change",update);
update();
</script>
</body>
</html>